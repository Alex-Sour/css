#!/bin/bash

# This workflow runs axe checks when doc paths with examples are modified.
# Developers frequently copy and paste examples from documentation so it's important to ensure the examples are accessible.
# Learn more about @axe-core/cli here: https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli

# See which files were modified not including deleted files

${{ steps.changed-files.outputs.all_changed_files }} > files.txt

# Grab the paths of pages we care about
relevant_nav_paths=()
while IFS= read -r file
do
  if [[ $file == docs/content/components/* ]] || [[ $file == docs/content/utilities/* ]] ; then
    if [[ $file == docs/content/components/index.md ]] || [[ $file == docs/content/utilities/index.md ]] ; then
      echo "Skipping $file"
      echo "*"
      echo "*"
      continue
    else
      prefix="docs/content"
      suffix=".md"
      doc_path=${file#"$prefix"}
      doc_path=${doc_path%"$suffix"}
      relevant_nav_paths+=($doc_path)
    fi
  else
    echo "Skipping $file"
    echo "*"
    echo "*"
  fi
done < files.txt
rm files.txt

skip_axe_message="Skipping axe testing because there were no changes to documentation pages we care about"

# Return early if no relevant files were modified
if [ ${#relevant_nav_paths[@]} -eq 0 ]; then
  echo $skip_axe_message
  exit
else
  echo "Verify whether the check is part of starting point violation"
  echo "*"
  echo "*"
fi

# https://stackoverflow.com/a/8574392
containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && return 0; done
  return 1
}

# Starting point violations
# DO NOT ADD TO THIS LIST!
needs_to_be_fixed=(
  /components/autocomplete
  /components/avatars
  /components/box
  /components/buttons
  /components/header
  /components/markdown
  /components/progress
  /components/select-menu
  /components/labels
  /components/timeline
  /components/toasts
  /utilities/flexbox
  /utilities/layout 
)

echo "############################################################"
echo "WARNING"
echo "The following paths are excluded from this automated accessibility check."
echo "They contain known violations and should be addressed:"
printf '%s\n' "${needs_to_be_fixed[@]}"
echo "############################################################"

# Generate doc urls for testing
doc_urls=()
for i in "${relevant_nav_paths[@]}"; 
do
  if containsElement "${i//\"/}" "${needs_to_be_fixed[@]}"; then
    continue
  else
    doc_url="http://localhost:8000$i"
    doc_url="${doc_url//\"/}"
    doc_urls+=($doc_url)
  fi
done

# Run axe checks only if there are pages to run it on
if [ ${#doc_urls[@]} -eq 0 ]; then
  echo $skip_axe_message
  exit
else
  echo 
  npm install -g @axe-core/cli
  # https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli
  # We exclude rules that depend on full page context.
  npm run dev & npx wait-on http://localhost:8000
  axe ${doc_urls[@]} --include "iframe" --disable html-has-lang,frame-title,page-has-heading-one,region,color-contrast,landmark-unique,landmark-one-main --show-errors
fi
