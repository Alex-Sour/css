#!/bin/bash

# This workflow runs axe checks on modified doc/content/components/* or doc/content/components/* pages because those include code examples.
# Developers frequently copy and paste examples from documentation so it's important to ensure the examples are accessible.
# Learn about @axe-core/cli: https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli

array=($MODIFIED_COMPONENT_OR_UTILITIES_PATHS)
printf "%s\n" "${array[@]}" > temp.txt

# Store the paths of pages we care about
nav_paths=()
while IFS= read -r file
do
  prefix="docs/content"
  suffix=".md"
  doc_path=${file#"$prefix"}
  doc_path=${doc_path%"$suffix"}
  nav_paths+=($doc_path)
done < temp.txt
rm temp.txt

# Return early if no relevant files were modified
echo "Verify whether ${nav_paths[@]} is part of starting point violation"
echo "*"
echo "*"

# https://stackoverflow.com/a/8574392
containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && return 0; done
  return 1
}

# Starting point violations
# DO NOT ADD TO THIS LIST!
skipped=(
  /components/autocomplete
  /components/avatars
  /components/box
  /components/buttons
  /components/header
  /components/markdown
  /components/progress
  /components/select-menu
  /components/labels
  /components/timeline
  /components/toasts
  /utilities/flexbox
  /utilities/layout 
)

# Generate doc urls for testing
doc_urls=()
skipped=()
for i in "${nav_paths[@]}"; 
do
  if containsElement "${i//\"/}" "${needs_to_be_fixed[@]}"; then
    skipped+=($i)
    continue
  else
    doc_url="http://localhost:8000$i"
    doc_url="${doc_url//\"/}"
    doc_urls+=($doc_url)
  fi
done

if (( ${#skipped[@]} )); then
  echo "############################################################"
  echo "WARNING"
  echo "The following paths are excluded from axe checks because they are part of starting point violations:"
  printf '%s\n' "${needs_to_be_fixed[@]}"
  echo ""
  echo ""
  echo "While you're working in:"
  printf '%s\n' "${skipped[@]}"
  echo "will you consider fixing the accessibility issues so we can remove it from the list? ❤️"
  echo "############################################################"
fi

# Run axe checks only if there are pages to run it on
if [ ${#doc_urls[@]} -eq 0 ]; then
  exit
else
  npm install -g @axe-core/cli
  # https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli
  # We exclude rules that depend on full page context.
  axe ${doc_urls[@]} --include "iframe" --disable html-has-lang,frame-title,page-has-heading-one,region,color-contrast,landmark-unique,landmark-one-main --exit --show-errors
fi
