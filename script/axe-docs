#!/bin/bash

# This workflow runs axe checks on modified doc/content/components/* or doc/content/components/* pages because those include code examples.
# Developers frequently copy and paste examples from documentation so it's important to ensure the examples are accessible.
# Learn about @axe-core/cli: https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli

if [ ${#CHANGED_DOCS_PATH[@]} -eq 0 ]; then
  echo "CHANGED_DOCS_PATH must be set to run axe checks."
  exit
fi

printf "%s\n" "${CHANGED_DOCS_PATH[@]}" > temp.txt
nav_paths=()
while IFS= read -r file
do
  prefix="docs/content"
  suffix=".md"
  doc_path=${file#"$prefix"}
  doc_path=${doc_path%"$suffix"}
  nav_paths+=($doc_path)
done < temp.txt
rm temp.txt

echo $nav_paths
# https://stackoverflow.com/a/8574392
containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && return 0; done
  return 1
}

# Starting point violations list
# DO NOT ADD TO THIS LIST!
needs_to_be_fixed=(
  /components/autocomplete
  /components/avatars
  /components/box
  /components/buttons
  /components/header
  /components/markdown
  /components/progress
  /components/select-menu
  /components/labels
  /components/timeline
  /components/toasts
  /utilities/flexbox
  /utilities/layout 
)

# Generate doc urls for testing
doc_urls=()
skipped=()
for i in "${nav_paths[@]}"; 
do
  if containsElement "${i//\"/}" "${needs_to_be_fixed[@]}"; then
    echo "Skipping $i"
    skipped+=($i)
  else
    doc_url="http://localhost:8000$i"
    doc_url="${doc_url//\"/}"
    doc_urls+=($doc_url)
  fi
done

if (( ${#skipped[@]} )); then
  echo "==========================================================================================="
  echo "WARNING"
  echo ""
  echo "Oh no! We had to skip accessibility checks on:"
  echo ""
  printf '%s\n' "${skipped[@]}"
  echo ""
  echo "because they are part of the starting point violations list."
  echo ""
  echo "Help us get one closer to getting rid of this list!"
  echo "Consider addressing the accessibility issues on the examples of these pages as part of your PR ❤️"
  echo "==========================================================================================="
fi

# Run axe checks only if there are pages to run it on
if [ ${#doc_urls[@]} -eq 0 ]; then
  exit
else
  npm install -g @axe-core/cli
  # https://github.com/dequelabs/axe-core-npm/tree/develop/packages/cli
  # We exclude rules that depend on full page context.
  axe ${doc_urls[@]} --include "iframe" --disable html-has-lang,frame-title,page-has-heading-one,region,color-contrast,landmark-unique,landmark-one-main --exit --show-errors
fi
